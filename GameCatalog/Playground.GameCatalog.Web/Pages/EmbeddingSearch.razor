@page "/gamecatalog/search"

@using Microsoft.AspNetCore.WebUtilities

@inject CatalogClient CatalogClient
@inject IDialogService DialogService
@inject NavigationManager NavigationManager

<PageTitle>Game Catalog</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">
    Text embedding search 
    <MudButton Variant="Variant.Filled" EndIcon="@Icons.Material.Filled.Refresh" Color="Color.Primary" OnClick="OpenGenerateEmbeddingsDialog">Generate</MudButton>
</MudText>
<MudText Class="mb-8">
    Ever wondered how an AI finds the difference between "cat videos" and "quantum physics"? <br />
    Welcome to a text embedding search playground, where your words are magically transformed into numbers, <br />
    and those numbers help you find what you never knew you needed. It's like Google, but with more existential dread.
</MudText>

<MudText Typo="Typo.h4" GutterBottom="true">Inspiration:</MudText>
<MudText Class="mb-8 pl-8">
<ul>
    <li>recent puzzle games</li>
    <li>co-op platformers released after 2020</li>
    <li>games with time travel mechanics</li>
    <li>highly rated singleplayer adventures</li>
    <li>cheap multiplayer shooters</li>
    <li>fantasy RPGs available on Steam Deck</li>
    <li>story rich indie games</li>
    <li>games with positive reviews and controller support</li>
    <li>classic action games for Linux</li>
    <li>new releases with great soundtracks</li>
</ul>
</MudText>

<MudTextField @bind-Value="SearchQuery" Placeholder="Search games..." Variant="Variant.Outlined" FullWidth="true" Disabled="@isLoading"
    Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search" OnAdornmentClick="SearchGames" 
    OnKeyUp="SearchOnEnter" />

<MudProgressLinear Class="mt-2" Color="Color.Primary" Indeterminate="true" Style="@(isLoading ? "visibility: visible;" : "visibility: hidden;")" />

@if (games.Any())
{
    <MudGrid Class="mt-8">
        @foreach (var game in games)
        {
            <MudItem xs="12" sm="6" md="4" lg="3">
                <GameCard Game="@game" />
            </MudItem>
        }
    </MudGrid>
}
else if (!isLoading && !string.IsNullOrWhiteSpace(SearchQuery))
{
    <MudText Typo="Typo.body1" Class="mt-8">No games found for "<strong>@SearchQuery</strong>"</MudText>
}


@code {
    [SupplyParameterFromQuery(Name = "q")]
    private string SearchQuery { get; set; } = string.Empty;
    private Game[] games = [];
    private bool isLoading;

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrWhiteSpace(SearchQuery))
        {
            await SearchGames();
        }
    }

    private async Task SearchOnEnter(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !isLoading)
        {
            await SearchGames();
        }
    }

    private async Task SearchGames()
    {      
        isLoading = true;
        games = [];

        try
        {
            if (string.IsNullOrWhiteSpace(SearchQuery))
            {
                games = [];
                return;
            } 

            games = await CatalogClient.Search(SearchQuery);
        }
        finally
        {
            UpdateSearchQueryParameter(SearchQuery);
            isLoading = false;
        }
    }

    private void UpdateSearchQueryParameter(string searchTerm)
    {
        var oldSearchParam = GetSearchQueryParameter();
        var newSearchParam = string.IsNullOrWhiteSpace(searchTerm) ? null : searchTerm;

        if(oldSearchParam == newSearchParam)
        {
            return;
        }

        var uri = NavigationManager.GetUriWithQueryParameter("q", newSearchParam);
        NavigationManager.NavigateTo(uri, replace: true);
    }

    private string? GetSearchQueryParameter()
    {
        var uri = new Uri(NavigationManager.Uri);
        QueryHelpers.ParseQuery(uri.Query).TryGetValue("q", out var searchTerm);
        return searchTerm;
    }

    private async Task OpenGenerateEmbeddingsDialog()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        await DialogService.ShowAsync<GenerateEmbeddingsDialog>("Generate Embeddings...", options: options);
    }
}
