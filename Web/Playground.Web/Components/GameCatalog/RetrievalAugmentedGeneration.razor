@page "/gamecatalog/rag"
@using System.Text

@inject GameCatalogClient GameCatalogClient

<PageTitle>Game Catalog</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">
    Retrieval‑augmented generation (RAG)
</MudText>

<MudText Class="mb-8">
    This page uses Retrieval‑Augmented Generation (RAG) to answer questions using our game catalog only. <br />
    We embed each game's title, tags, and description, retrieve the most relevant games for your question, <br />
    and generate a concise reply grounded in those results. Ask about genres, prices, ratings, or specific titles.
</MudText>

<MudText Typo="Typo.h4" GutterBottom="true">Inspiration:</MudText>
<MudText Class="mb-8 pl-8">
<ul>
    <li>What are some recent puzzle games under $30?</li>
    <li>Which co-op platformers were released after 2020?</li>
    <li>Do you have games with time travel mechanics?</li>
    <li>What are some highly rated singleplayer adventures?</li>
    <li>Are there any cheap multiplayer shooters?</li>
    <li>Which fantasy RPGs are available on Steam Deck?</li>
    <li>What are some story-rich indie games?</li>
    <li>Do you have games with positive reviews and controller support?</li>
    <li>Which classic action games run on Linux?</li>
    <li>What new releases have great soundtracks?</li>
</ul>
</MudText>

<MudGrid>
    <MudItem xs="6">
        <MudPaper Class="pa-4" Elevation="2">

            <MudTextField @bind-Value="SystemPrompt" Label="System prompt:" Variant="Variant.Outlined" Lines="8" />
            <MudTextField @bind-Value="FewShotExamples" Label="Few-shot examples:" Variant="Variant.Outlined" Lines="4" />

            <MudTextField @bind-Value="Question" Placeholder="Ask about games, tags, price, reviews..." Variant="Variant.Outlined" FullWidth="true" Disabled="@isLoading"
                Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Send" OnAdornmentClick="GetAnswer" 
                OnKeyUp="AnswerOnEnter" />
            
            <MudProgressLinear Class="mt-2" Color="Color.Primary" Indeterminate="true" Style="@(isLoading ? "visibility: visible;" : "visibility: hidden;")" />

            @for (var i = chatMessages.Count - 1; i >= 0; i--)
            {
                var message = chatMessages[i];
                <MudChat ChatPosition="@(i % 2 == 0 ? ChatBubblePosition.End : ChatBubblePosition.Start)">
                    <MudChatBubble>
                        @ToMarkup(message)
                    </MudChatBubble>
                </MudChat>
            }
        </MudPaper>
    </MudItem>
</MudGrid>


@code {
    private string SystemPrompt { get; set; } = CreateSystemPrompt();
    private string FewShotExamples { get; set; } = CreateFewShotExamples();
    private string Question { get; set; } = string.Empty;
    private List<string> chatMessages = new();
    private bool isLoading;

    private async Task AnswerOnEnter(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !isLoading)
        {
            await GetAnswer();
        }
    }

    private async Task GetAnswer()
    {
        if (string.IsNullOrWhiteSpace(Question)) return;
        
        isLoading = true;
        chatMessages.Add(Question);

        try
        {
            var result = await GameCatalogClient.AnswerCatalogQuestion(SystemPrompt, FewShotExamples, Question);
            chatMessages.Add(result.Answer);
        }
        catch
        {
            chatMessages.Add("We couldn't process your request right now.");
        }
        finally
        {
            isLoading = false;
        }
    }

    private static string CreateSystemPrompt()
    {
        return "You are a helpful Game Catalog Assistant.\n" +
            "- Only answer using the facts provided in the Context.\n" +
            "- If the answer is not in the Context, reply why, maybe it's a playstation game not available on steam.\n" +
            "- Refuse any non-game-related questions politely and funny.\n" +
            "- Keep answers concise and fun to read.\n" +
            "- If the users asks more info about a game don't give a list with details. Include a short summary of the tags and the game description.\n" +
            "- Format the answer in html, use HTML tags like <ul>, <ol>, <li>, <strong>, <p>, never add markdown syntax.";
    }

    private static string CreateFewShotExamples()
    {
        return "Q: Do you have any racing games under $20?\n" +
            "A: Yes, we have several racing games under $20. GT Legends is one of them and is priced at $19.99.\n" +
            "Q: Can you give me some prime numbers?\n" +
            "A: I don't know, I can only answer questions about games in my catalog, this seems a math problem and is way over my head.";
    }
}